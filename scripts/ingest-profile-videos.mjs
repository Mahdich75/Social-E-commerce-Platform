import fs from 'node:fs';
import path from 'node:path';

const SOURCE_DIR = process.argv[2] || 'C:\\Users\\mcher\\Downloads\\Profile';
const projectRoot = process.cwd();
const targetDir = path.join(projectRoot, 'public', 'videos', 'profile');
const outputFile = path.join(projectRoot, 'src', 'app', 'data', 'generatedProfiles.ts');

const VIDEO_EXTENSIONS = new Set(['.mp4', '.mov', '.webm', '.m4v']);
const AVATAR_POOL = ['/pics/avatars/avatar1.jpg', '/pics/avatars/avatar2.jpg', '/pics/avatars/avatar3.jpg', '/pics/avatars/avatar4.jpg'];

const hashCode = (value) => {
  let hash = 0;
  for (let i = 0; i < value.length; i += 1) {
    hash = (hash * 31 + value.charCodeAt(i)) | 0;
  }
  return Math.abs(hash);
};

const toUsername = (folderName, fallbackIndex) => {
  const normalized = folderName.trim().replace(/\\+/g, '_').replace(/\s+/g, '_');
  const cleaned = normalized.replace(/^@+/, '');
  if (cleaned.length > 0) return cleaned;
  return `profile_${fallbackIndex + 1}`;
};

const toTitle = (fileName) =>
  path
    .parse(fileName)
    .name
    .replace(/[_-]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

if (!fs.existsSync(SOURCE_DIR)) {
  console.error(`Source directory does not exist: ${SOURCE_DIR}`);
  process.exit(1);
}

fs.mkdirSync(targetDir, { recursive: true });

const profileFolders = fs
  .readdirSync(SOURCE_DIR, { withFileTypes: true })
  .filter((entry) => entry.isDirectory())
  .map((entry) => entry.name)
  .sort((a, b) => a.localeCompare(b, 'fa'));

const creators = [];
const profileMedia = [];

profileFolders.forEach((folderName, folderIndex) => {
  const folderPath = path.join(SOURCE_DIR, folderName);
  const folderKey = `profile-${hashCode(folderName).toString(16).slice(0, 8)}`;
  const targetFolder = path.join(targetDir, folderKey);
  fs.mkdirSync(targetFolder, { recursive: true });

  const username = toUsername(folderName, folderIndex);
  const avatar = AVATAR_POOL[folderIndex % AVATAR_POOL.length];
  const creatorId = `creator_${hashCode(username).toString(16).slice(0, 10)}`;

  const files = fs
    .readdirSync(folderPath, { withFileTypes: true })
    .filter((entry) => entry.isFile())
    .map((entry) => entry.name)
    .filter((fileName) => VIDEO_EXTENSIONS.has(path.extname(fileName).toLowerCase()))
    .sort((a, b) => a.localeCompare(b, 'fa'));

  if (files.length === 0) return;

  const reels = [];
  let introVideoUrl;
  let introVideoName;

  files.forEach((fileName, fileIndex) => {
    const ext = path.extname(fileName).toLowerCase();
    const fileHash = hashCode(`${folderName}/${fileName}`).toString(16).slice(0, 10);
    const safeName = `clip-${fileIndex + 1}-${fileHash}${ext}`;

    fs.copyFileSync(path.join(folderPath, fileName), path.join(targetFolder, safeName));

    const videoUrl = `/videos/profile/${folderKey}/${safeName}`;
    const title = toTitle(fileName);
    const isIntro = /^intro[-_]/i.test(path.parse(fileName).name);

    reels.push({
      id: `pv-${folderKey}-${fileIndex + 1}`,
      videoUrl,
      thumbnail: `https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=414&h=736&fit=crop&seed=${folderKey}-${fileIndex + 1}`,
      title,
      isIntro,
    });

    if (isIntro && !introVideoUrl) {
      introVideoUrl = videoUrl;
      introVideoName = title || fileName;
    }
  });

  if (!introVideoUrl && reels.length > 0) {
    introVideoUrl = reels[0].videoUrl;
    introVideoName = reels[0].title;
  }

  creators.push({ id: creatorId, username, avatar });
  profileMedia.push({
    username,
    introVideoUrl: introVideoUrl || '',
    introVideoName: introVideoName || '',
    reels,
  });
});

const output = `/* Auto-generated by scripts/ingest-profile-videos.mjs. Do not edit manually. */\n\nexport interface GeneratedProfileCreator {\n  id: string;\n  username: string;\n  avatar: string;\n}\n\nexport interface GeneratedProfileMediaReel {\n  id: string;\n  videoUrl: string;\n  thumbnail: string;\n  title: string;\n  isIntro: boolean;\n}\n\nexport interface GeneratedProfileMedia {\n  username: string;\n  introVideoUrl: string;\n  introVideoName: string;\n  reels: GeneratedProfileMediaReel[];\n}\n\nexport const generatedProfileCreators: GeneratedProfileCreator[] = ${JSON.stringify(creators, null, 2)};\n\nexport const generatedProfileMedia: GeneratedProfileMedia[] = ${JSON.stringify(profileMedia, null, 2)};\n`;

fs.writeFileSync(outputFile, output, 'utf8');

console.log(`Generated ${creators.length} profile creators.`);
console.log(`Copied videos into: ${targetDir}`);
console.log(`Generated data file: ${outputFile}`);
